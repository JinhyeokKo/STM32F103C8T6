#include "fnd_controller.h"

#define HIGH 1
#define LOW 0

void send(uint8_t X){
	for (int i = 8; i >= 1; i--) {
		if (X & 0x80) {
			HAL_GPIO_WritePin(FND_DIO_GPIO_Port, FND_DIO_Pin, HIGH);
		} else {
			HAL_GPIO_WritePin(FND_DIO_GPIO_Port, FND_DIO_Pin, LOW);
		}
		X <<= 1;
		HAL_GPIO_WritePin(FND_SCLK_GPIO_Port, FND_SCLK_Pin, LOW);
		HAL_GPIO_WritePin(FND_SCLK_GPIO_Port, FND_SCLK_Pin, HIGH);
	}
}

void send_port(uint8_t X, uint8_t port){
	send(X);
	send(port);
	HAL_GPIO_WritePin(FND_RCLK_GPIO_Port, FND_RCLK_Pin, LOW);
	HAL_GPIO_WritePin(FND_RCLK_GPIO_Port, FND_RCLK_Pin, HIGH);
}

void digit4_show(int n, int replay, uint8_t showZero) {
	int n1, n2, n3, n4;

	n1 = (int) n % 10;
	n2 = (int) ((n % 100)) / 10;
	n3 = (int) ((n % 1000)) / 100;
	n4 = (int) ((n % 10000)) / 1000;

	for (int i = 0; i <= replay; i++) {
		send_port(_LED_0F[n1], 0b0001);
		if (showZero | n > 9){
			send_port(_LED_0F[n2], 0b0010);
		}
		if (showZero | n > 99){
			send_port(_LED_0F[n3], 0b0100);
		}
		if (showZero | n > 999){
			send_port(_LED_0F[n4], 0b1000);
		}
	}
}

void digit4_replay(int n, int replay) {
	digit4_show(n, replay, false);
}

void digit4(int n) {
	digit4_show(n, 0, false);
}

void digit4showZero_replay(int n, int replay) {
	digit4_show(n, replay, true);
}

void digit4showZero(int n) {
	digit4_show(n, 0, true);
}

void digit2(int n, int port, int replay) {
	int n1, n2;
	n1 = (int) n % 10;
	n2 = (int) ((n % 100) - n1) / 10;

	for (int i = 0; i <= replay; i++) {
		send_port(_LED_0F[n1], port);
		send_port(_LED_0F[n2], port << 1);
	}
}

void digit2_port(int n, int port) {
	digit2(n, port, 0);
}

